# Harness Pipeline - PRD Environment
# Triggered on push to main/master branch
# Requires manual approval before deployment
# Blue-Green deployment strategy
#
# IMPORTANTE: Este é um TEMPLATE de exemplo
# Substitua 'myapp' pelo nome real da sua aplicação
# Ajuste URLs, namespaces e paths conforme seu ambiente
# Configure approvers no grupo 'prod_approvers'

pipeline:
  name: CI/CD PRD (Production)
  identifier: cicd_prd
  projectIdentifier: asgard_project
  orgIdentifier: default
  
  tags:
    environment: prd
    project: myapp
    criticality: high
  
  properties:
    ci:
      codebase:
        connectorRef: github_connector
        repoName: myorg/myapp
        build:
          type: branch
          spec:
            branch: main
  
  stages:
    # Stage 1: Security Scanning - BLOCKING
    - stage:
        name: Security Scan (BLOCKING)
        identifier: security_scan
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              # Semgrep SAST - BLOCKING for PRD
              - step:
                  type: Run
                  name: Semgrep SAST Scan
                  identifier: semgrep_scan
                  spec:
                    connectorRef: kubernetes_delegate
                    image: semgrep/semgrep:latest
                    shell: Sh
                    command: |
                      echo "Running Semgrep security scan (BLOCKING for PRD)..."
                      
                      # Run auto rules - FAIL on findings
                      semgrep --config=auto --error --json --output=semgrep.json src/
                      
                      # Run custom rules
                      if [ -f ".semgrep/rules/security.yml" ]; then
                        semgrep --config=.semgrep/rules/ --error --json --output=semgrep-custom.json src/
                      fi
                      
                      echo "✅ Semgrep scan passed - no security issues found"
                    
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - semgrep.json
                  
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Abort  # FAIL pipeline on security issues
    
    # Stage 2: Tests - Must Pass
    - stage:
        name: Tests (Must Pass)
        identifier: tests
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              - step:
                  type: Run
                  name: Unit Tests
                  identifier: unit_tests
                  spec:
                    connectorRef: kubernetes_delegate
                    image: python:3.11-slim
                    shell: Sh
                    command: |
                      echo "Installing dependencies..."
                      pip install -r requirements.txt
                      pip install pytest pytest-cov
                      
                      echo "Running unit tests (must pass)..."
                      pytest tests/unit/ --cov=. --cov-report=xml --cov-report=term --cov-fail-under=80
                    
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - coverage.xml
              
              - step:
                  type: Run
                  name: Integration Tests
                  identifier: integration_tests
                  spec:
                    connectorRef: kubernetes_delegate
                    image: python:3.11-slim
                    shell: Sh
                    command: |
                      echo "Running integration tests..."
                      pytest tests/integration/ -v --maxfail=1
              
              - step:
                  type: Run
                  name: Code Quality (Strict)
                  identifier: code_quality
                  spec:
                    connectorRef: kubernetes_delegate
                    image: python:3.11-slim
                    shell: Sh
                    command: |
                      pip install pylint flake8
                      
                      # Strict linting for production
                      flake8 src/ --max-line-length=120 --max-complexity=10
                      pylint src/ --fail-under=8.0
    
    # Stage 3: Build & Security Scan
    - stage:
        name: Build and Security Scan
        identifier: build_scan
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              # Build Docker image
              - step:
                  type: BuildAndPushDockerRegistry
                  name: Build and Push to Harbor PRD
                  identifier: build_push_harbor
                  spec:
                    connectorRef: harbor_connector
                    repo: 192.168.1.81:30880/prd/myapp
                    tags:
                      - prod-<+pipeline.sequenceId>
                      - prod-<+codebase.commitSha>
                      - v<+pipeline.variables.VERSION>
                      - latest
                      - stable
                    dockerfile: Dockerfile
                    context: .
                    buildArgs:
                      ENV: prd
                      VERSION: <+pipeline.variables.VERSION>
                    optimize: true
                    caching: true
              
              # Trivy scan - BLOCKING on CRITICAL
              - step:
                  type: Run
                  name: Trivy Container Scan (BLOCKING)
                  identifier: trivy_scan
                  spec:
                    connectorRef: kubernetes_delegate
                    image: aquasec/trivy:latest
                    shell: Sh
                    command: |
                      echo "Scanning image for CRITICAL vulnerabilities (BLOCKING)..."
                      
                      trivy image \
                        --severity CRITICAL \
                        --exit-code 1 \
                        --format json \
                        --output trivy-report.json \
                        192.168.1.81:30880/prd/myapp:prod-<+pipeline.sequenceId>
                      
                      echo "✅ No CRITICAL vulnerabilities found"
                      
                      # Also check HIGH (warning only)
                      echo "Checking HIGH severity vulnerabilities..."
                      trivy image \
                        --severity HIGH \
                        --format table \
                        192.168.1.81:30880/prd/myapp:prod-<+pipeline.sequenceId> || true
                  
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Abort  # FAIL on critical vulnerabilities
              
              # Wait for Harbor to complete scan
              - step:
                  type: ShellScript
                  name: Verify Harbor Scan
                  identifier: verify_harbor_scan
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          echo "Waiting for Harbor to complete vulnerability scan..."
                          sleep 60
                          
                          # Harbor will block image with critical vulns in PRD project
                          echo "✅ Harbor scan verification complete"
                    timeout: 3m
    
    # Stage 4: Manual Approval
    - stage:
        name: Manual Approval
        identifier: manual_approval
        type: Approval
        spec:
          execution:
            steps:
              - step:
                  type: HarnessApproval
                  name: Production Deployment Approval
                  identifier: prod_approval
                  spec:
                    approvalMessage: |
                      Please review and approve production deployment:
                      
                      - Image: 192.168.1.81:30880/prd/myapp:prod-<+pipeline.sequenceId>
                      - Version: v<+pipeline.variables.VERSION>
                      - Commit: <+codebase.commitSha>
                      - Branch: <+codebase.branch>
                      - Author: <+pipeline.triggeredBy.name>
                      
                      Security Scans:
                      - Semgrep: ✅ Passed
                      - Trivy: ✅ No critical vulnerabilities
                      - Harbor: ✅ Scan complete
                      
                      Tests:
                      - Unit Tests: ✅ Passed (coverage ≥80%)
                      - Integration Tests: ✅ Passed
                      - Code Quality: ✅ Passed
                    
                    approvers:
                      userGroups:
                        - prod_approvers
                        - tech_leads
                      minimumCount: 2
                      disallowPipelineExecutor: false
                    
                    approverInputs: []
                    timeout: 24h
                    
                    includePipelineExecutionHistory: true
                    isAutoRejectEnabled: false
    
    # Stage 5: Deploy to PRD (Blue-Green)
    - stage:
        name: Deploy to PRD
        identifier: deploy_prd
        type: Deployment
        spec:
          deploymentType: Kubernetes
          service:
            serviceRef: myapp_prd
            serviceInputs:
              serviceDefinition:
                type: Kubernetes
                spec:
                  artifacts:
                    primary:
                      primaryArtifactRef: harbor_prd_image
                      sources:
                        - identifier: harbor_prd_image
                          type: DockerRegistry
                          spec:
                            tag: prod-<+pipeline.sequenceId>
          
          environment:
            environmentRef: prd
            deployToAll: false
            infrastructureDefinitions:
              - identifier: prd_k8s_infra
          
          execution:
            steps:
              # Blue-Green Deployment
              - step:
                  type: K8sBlueGreenDeploy
                  name: Deploy Green (New Version)
                  identifier: bluegreen_deploy
                  spec:
                    skipDryRun: false
                    pruningEnabled: false
              
              # Integration Tests on Green
              - step:
                  type: ShellScript
                  name: Integration Tests on Green
                  identifier: integration_tests_green
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -e
                          
                          echo "Running integration tests on green deployment..."
                          
                          # Test via green service (before switching traffic)
                          SERVICE_URL="http://myapp-green.prd.svc.cluster.local:8080"
                          
                          # Health check
                          response=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/health)
                          if [ "$response" != "200" ]; then
                            echo "❌ Health check failed: HTTP $response"
                            exit 1
                          fi
                          
                          # Critical API endpoints
                          curl -f $SERVICE_URL/api/v1/status || exit 1
                          
                          echo "✅ Integration tests passed on green"
                    timeout: 10m
              
              # Switch Traffic to Green
              - step:
                  type: K8sBGSwapServices
                  name: Switch Traffic to Green
                  identifier: swap_services
                  spec:
                    skipDryRun: false
              
              # Monitor New Deployment
              - step:
                  type: ShellScript
                  name: Monitor Metrics
                  identifier: monitor_metrics
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          echo "Monitoring production metrics for 2 minutes..."
                          sleep 120
                          
                          # Query Prometheus for error rate/latency
                          # (placeholder - adjust to your metrics)
                          echo "Checking error rate..."
                          # error_rate=$(curl -s "http://prometheus:9090/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])")
                          
                          echo "✅ Metrics look healthy"
                    timeout: 5m
              
              # Production Smoke Tests
              - step:
                  type: ShellScript
                  name: Production Smoke Tests
                  identifier: smoke_tests
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -e
                          
                          echo "Running production smoke tests..."
                          
                          # Test public URL
                          SERVICE_URL="https://myapp.asgard.com"
                          
                          response=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/health)
                          if [ "$response" != "200" ]; then
                            echo "❌ Public health check failed: HTTP $response"
                            exit 1
                          fi
                          
                          echo "✅ Production smoke tests passed"
                    timeout: 5m
            
            # Rollback if anything fails
            rollbackSteps:
              - step:
                  type: K8sBlueGreenRollback
                  name: Rollback to Blue (Previous Version)
                  identifier: rollback_bluegreen
    
    # Stage 6: Post-Deployment
    - stage:
        name: Post-Deployment
        identifier: post_deployment
        type: Custom
        spec:
          execution:
            steps:
              # Tag Git commit
              - step:
                  type: ShellScript
                  name: Create Git Tag
                  identifier: git_tag
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          VERSION="v<+pipeline.variables.VERSION>"
                          
                          git config user.name "Harness CI/CD"
                          git config user.email "ci@asgard.com"
                          
                          git tag -a $VERSION -m "Production release $VERSION"
                          git push origin $VERSION
                          
                          echo "✅ Created and pushed tag: $VERSION"
                    timeout: 2m
              
              # Update documentation
              - step:
                  type: ShellScript
                  name: Update Release Notes
                  identifier: release_notes
                  spec:
                    shell: Bash
                    onDelegate: true
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          echo "Production deployment completed successfully!"
                          echo ""
                          echo "Version: v<+pipeline.variables.VERSION>"
                          echo "Image: prod-<+pipeline.sequenceId>"
                          echo "Deployed: $(date)"
                    timeout: 1m
  
  # Pipeline variables
  variables:
    - name: VERSION
      type: String
      description: Semantic version for this release
      required: true
      value: <+input>.default(1.0.<+pipeline.sequenceId>)
  
  # Notification settings
  notificationRules:
    - name: Production Pipeline Notification
      identifier: prod_pipeline_notification
      pipelineEvents:
        - type: PipelineSuccess
        - type: PipelineFailed
        - type: StageWaiting  # For approval
      notificationMethod:
        type: Slack
        spec:
          userGroups: []
          webhookUrl: <+secrets.getValue("slack_webhook_prod")>
      enabled: true
    
    - name: PagerDuty Alert on Failure
      identifier: pagerduty_alert
      pipelineEvents:
        - type: PipelineFailed
      notificationMethod:
        type: PagerDuty
        spec:
          integrationKey: <+secrets.getValue("pagerduty_key")>
      enabled: true

# ============================================================
# SERVICE DEFINITION - Exemplo/Template
# ============================================================
# Esta seção define o Service de PRODUÇÃO no Harness.
# CUSTOMIZE: Substitua 'myapp' pelo nome da sua aplicação
# e ajuste paths dos manifestos K8s conforme seu repositório.
#
# Exemplo: se sua app é 'backend-api', renomeie para:
#   - identifier: backend_api_prd
#   - name: backend-api-prd
#   - paths: k8s/prd/backend-api/
# ============================================================
---
service:
  name: myapp-prd
  identifier: myapp_prd
  serviceDefinition:
    type: Kubernetes
    spec:
      manifests:
        - manifest:
            identifier: k8s_manifests
            type: K8sManifest
            spec:
              store:
                type: Github
                spec:
                  connectorRef: github_connector
                  gitFetchType: Branch
                  branch: main
                  paths:
                    - k8s/prd/
              valuesPaths:
                - k8s/prd/values.yaml
              skipResourceVersioning: false
      
      artifacts:
        primary:
          primaryArtifactRef: harbor_prd_image
          sources:
            - identifier: harbor_prd_image
              type: DockerRegistry
              spec:
                connectorRef: harbor_connector
                imagePath: 192.168.1.81:30880/prd/myapp
                tag: <+input>
      
      variables:
        - name: NAMESPACE
          type: String
          value: prd
        - name: REPLICAS
          type: String
          value: "3"
        - name: ENV
          type: String
          value: production

# ============================================================
# ENVIRONMENT DEFINITION - Template
# ============================================================
# Define o ambiente PRD (production) no Harness.
# Esta seção é reutilizável para múltiplas aplicações.
# Configure approvers no Harness UI (grupo 'prod_approvers').
# ============================================================
---
environment:
  name: PRD
  identifier: prd
  type: Production
  tags:
    environment: production
    criticality: high
  variables:
    - name: NAMESPACE
      type: String
      value: prd
    - name: HARBOR_PROJECT
      type: String
      value: prd
  
  infrastructureDefinitions:
    - identifier: prd_k8s_infra
      name: PRD Kubernetes Cluster
      type: KubernetesDirect
      spec:
        connectorRef: kubernetes_delegate
        namespace: prd
        releaseName: myapp
