# Network Policies para segurança
# Restringe comunicação entre pods

---
# Policy 1: PostgreSQL aceita apenas de pods Supabase
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-supabase
  namespace: supabase
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Aceita de todos os pods Supabase no namespace
  - from:
    - podSelector:
        matchLabels: {}
    ports:
    - protocol: TCP
      port: 5432

---
# Policy 2: Serviços Supabase aceitam de Kong e entre si
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: supabase-services-allow-kong
  namespace: supabase
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - supabase-postgrest
      - supabase-gotrue
      - supabase-realtime
      - supabase-storage
  policyTypes:
  - Ingress
  ingress:
  # Aceita de Kong
  - from:
    - podSelector:
        matchLabels:
          app: supabase-kong
  # Aceita entre serviços (para comunicação interna)
  - from:
    - podSelector:
        matchExpressions:
        - key: app
          operator: In
          values:
          - supabase-postgrest
          - supabase-gotrue
          - supabase-realtime
          - supabase-storage

---
# Policy 3: Kong aceita de Ingress Controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-allow-ingress
  namespace: supabase
spec:
  podSelector:
    matchLabels:
      app: supabase-kong
  policyTypes:
  - Ingress
  ingress:
  # Aceita de namespace do Ingress Controller (Traefik/NGINX típicos)
  - from:
    - namespaceSelector:
        matchLabels:
          name: traefik  # ou kube-system para NGINX
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 8443
  # Aceita de qualquer lugar (para LoadBalancer externo)
  - from: []
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 8443

---
# Policy 4: Egress padrão (permite DNS e comunicação interna)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: supabase-allow-dns
  namespace: supabase
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  # DNS (kube-dns/coredns)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Comunicação interna no namespace
  - to:
    - podSelector: {}
  # Internet (para atualizações, webhooks, etc)
  - to:
    - namespaceSelector: {}
  - ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
