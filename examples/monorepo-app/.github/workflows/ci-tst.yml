name: CI/CD — TST (Staging)

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

env:
  HARBOR_REGISTRY: harbor.asgard.local
  HARBOR_PROJECT: tst
  K8S_NAMESPACE: app-tst

jobs:
  # =========================================================================
  # Detect which services changed
  # =========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      api-go: ${{ steps.filter.outputs.api-go }}
      api-python: ${{ steps.filter.outputs.api-python }}
      api-dotnet: ${{ steps.filter.outputs.api-dotnet }}
      kubernetes: ${{ steps.filter.outputs.kubernetes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'frontends/meu-app-web/**'
              - 'shared/**'
            api-go:
              - 'backends/api-go/**'
              - 'shared/**'
            api-python:
              - 'backends/api-python/**'
              - 'shared/**'
            api-dotnet:
              - 'backends/api-dotnet/**'
              - 'shared/**'
            kubernetes:
              - 'kubernetes/**'

  # =========================================================================
  # Security Scan
  # =========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/golang
            p/typescript
            p/react
            p/python
            p/csharp
            p/security-audit
        continue-on-error: true

  # =========================================================================
  # Frontend — React Web
  # =========================================================================
  web:
    name: Web (React)
    needs: [changes, security-scan]
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontends/meu-app-web/package-lock.json
      - run: npm ci
        working-directory: frontends/meu-app-web
      - run: npm run type-check
        working-directory: frontends/meu-app-web
      - run: npm run lint
        working-directory: frontends/meu-app-web
      - run: npm run test:coverage
        working-directory: frontends/meu-app-web
      - run: npm run build
        working-directory: frontends/meu-app-web
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - uses: docker/build-push-action@v6
        with:
          context: ./frontends/meu-app-web
          push: true
          tags: |
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/meu-app-web:dev-${{ github.sha }}
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/meu-app-web:develop
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web

  # =========================================================================
  # Backend — Go API
  # =========================================================================
  api-go:
    name: API Go
    needs: [changes, security-scan]
    if: needs.changes.outputs.api-go == 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env: { POSTGRES_USER: test, POSTGRES_PASSWORD: test, POSTGRES_DB: testdb }
        ports: ['5432:5432']
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: backends/api-go/go.sum
      - run: go mod download
        working-directory: backends/api-go
      - uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backends/api-go
      - name: Unit tests
        working-directory: backends/api-go
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/testdb?sslmode=disable
          REDIS_URL: redis://localhost:6379
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - uses: docker/build-push-action@v6
        with:
          context: ./backends/api-go
          push: true
          tags: |
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-go:dev-${{ github.sha }}
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-go:develop
          cache-from: type=gha,scope=api-go
          cache-to: type=gha,mode=max,scope=api-go

  # =========================================================================
  # Backend — Python API
  # =========================================================================
  api-python:
    name: API Python
    needs: [changes, security-scan]
    if: needs.changes.outputs.api-python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'
      - name: Install & test
        working-directory: backends/api-python
        run: |
          pip install -e ".[dev]"
          ruff check .
          mypy app/
          pytest tests/ -v --cov=app --cov-report=term-missing
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - uses: docker/build-push-action@v6
        with:
          context: ./backends/api-python
          push: true
          tags: |
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-python:dev-${{ github.sha }}
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-python:develop
          cache-from: type=gha,scope=api-python
          cache-to: type=gha,mode=max,scope=api-python

  # =========================================================================
  # Backend — .NET API
  # =========================================================================
  api-dotnet:
    name: API .NET
    needs: [changes, security-scan]
    if: needs.changes.outputs.api-dotnet == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Build & test
        working-directory: backends/api-dotnet
        run: |
          dotnet restore
          dotnet build --no-restore
          dotnet test --no-build --verbosity normal || true
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - uses: docker/build-push-action@v6
        with:
          context: ./backends/api-dotnet
          push: true
          tags: |
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-dotnet:dev-${{ github.sha }}
            ${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-dotnet:develop
          cache-from: type=gha,scope=api-dotnet
          cache-to: type=gha,mode=max,scope=api-dotnet

  # =========================================================================
  # Update K8s manifests (GitOps)
  # =========================================================================
  update-manifests:
    name: Update K8s Manifests
    needs: [web, api-go, api-python, api-dotnet]
    if: always() && contains(needs.*.result, 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: imranismail/setup-kustomize@v2
      - name: Update image tags
        working-directory: kubernetes/overlays/tst
        run: |
          [ "${{ needs.web.result }}" = "success" ] && kustomize edit set image meu-app-web=${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/meu-app-web:dev-${{ github.sha }} || true
          [ "${{ needs.api-go.result }}" = "success" ] && kustomize edit set image api-go=${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-go:dev-${{ github.sha }} || true
          [ "${{ needs.api-python.result }}" = "success" ] && kustomize edit set image api-python=${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-python:dev-${{ github.sha }} || true
          [ "${{ needs.api-dotnet.result }}" = "success" ] && kustomize edit set image api-dotnet=${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/api-dotnet:dev-${{ github.sha }} || true
      - name: Commit & push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add kubernetes/overlays/tst/
          git diff --staged --quiet || git commit -m "chore(tst): update images to dev-${{ github.sha }}"
          git push

  # =========================================================================
  # Notify
  # =========================================================================
  notify:
    name: Notify
    needs: [web, api-go, api-python, api-dotnet, update-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            :rocket: TST Deploy
            Web: ${{ needs.web.result }}
            API Go: ${{ needs.api-go.result }}
            API Python: ${{ needs.api-python.result }}
            API .NET: ${{ needs.api-dotnet.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
